name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"

jobs:
  # Quality Assurance
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"

      - name: Run ruff linting
        run: ruff check jml_engine/ --output-format=github

      - name: Run black formatting check
        run: black --check jml_engine/ tests/

      - name: Run mypy type checking
        run: mypy jml_engine/
        continue-on-error: true

      - name: Run security scanning
        run: |
          pip install bandit[sarif]
          bandit -r jml_engine/ -f sarif -o bandit-results.sarif 2>/dev/null || echo "{}" > bandit-results.sarif
        continue-on-error: true

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: bandit-results.sarif
        if: always() && hashFiles('bandit-results.sarif') != ''
        continue-on-error: true

  # Testing
  test:
    name: Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"

      - name: Run tests
        run: |
          pytest tests/ \
            --cov=jml_engine \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=junit-report.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            junit-report.xml
            htmlcov/
        if: always()

  # Integration Tests
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [quality, test]
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"

      - name: Run integration tests
        run: |
          pytest tests/ -m integration --tb=short
        env:
          REDIS_URL: redis://localhost:6379

      - name: Test API endpoints
        run: |
          python -c "
          import subprocess
          import time
          import requests

          # Start API server
          server = subprocess.Popen(['python', '-m', 'jml_engine.api.server'],
                                  stdout=subprocess.PIPE, stderr=subprocess.PIPE)

          try:
            time.sleep(5)  # Wait for server to start

            # Test health endpoint
            response = requests.get('http://localhost:8000/health', timeout=10)
            assert response.status_code == 200
            assert response.json()['status'] == 'healthy'

            # Test OpenAPI docs
            response = requests.get('http://localhost:8000/docs', timeout=10)
            assert response.status_code == 200

            print('‚úÖ API integration tests passed')

          finally:
            server.terminate()
            server.wait()
          "

  # Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.29.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
        if: always()
        continue-on-error: true

      - name: Dependency vulnerability scan
        run: |
          pip install safety
          safety check --output json > safety-results.json || true
        continue-on-error: true

      - name: Upload Safety results
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: safety-results.json
        if: always()

  # Build and Test Containers
  container:
    name: Container Build
    runs-on: ubuntu-latest
    needs: [quality, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API container
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: false
          load: true
          tags: jml-engine-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Dashboard container
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.dashboard
          push: false
          load: true
          tags: jml-engine-dashboard:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test container startup
        run: |
          # Test API container
          docker run -d --name api-test -p 8000:8000 jml-engine-api:test
          sleep 10
          curl -f http://localhost:8000/health || (docker logs api-test && exit 1)
          docker stop api-test

          # Test Dashboard container
          docker run -d --name dashboard-test -p 8501:8501 jml-engine-dashboard:test
          sleep 10
          curl -f http://localhost:8501/health || (docker logs dashboard-test && exit 1)
          docker stop dashboard-test

  # Documentation
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: [quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate API documentation
        run: |
          python -c "
          from jml_engine.api.server import app
          from fastapi.openapi.utils import get_openapi

          try:
            openapi_schema = get_openapi(
              title=app.title,
              version=app.version,
              description=app.description,
              routes=app.routes,
            )

            import json
            with open('api-docs.json', 'w') as f:
              json.dump(openapi_schema, f, indent=2)
            print('‚úÖ API documentation generated successfully')
          except Exception as e:
            print(f'‚ö†Ô∏è  API documentation generation failed: {e}')
            # Create a minimal schema as fallback
            minimal_schema = {
              'openapi': '3.0.0',
              'info': {'title': 'JML Engine API', 'version': '1.0.0'},
              'paths': {}
            }
            with open('api-docs.json', 'w') as f:
              json.dump(minimal_schema, f, indent=2)
          "

      - name: Upload API documentation
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: api-docs.json

  # Release Preparation
  release:
    name: Release Preparation
    runs-on: ubuntu-latest
    needs: [quality, test, integration, security, container]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Check version consistency
        run: |
          # Check that version is consistent across files
          PYTHON_VERSION=$(python -c "import jml_engine; print(jml_engine.__version__)")
          PYPROJECT_VERSION=$(grep '^version =' pyproject.toml | cut -d'"' -f2)

          if [ "$PYTHON_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "Version mismatch: Python=$PYTHON_VERSION, pyproject.toml=$PYPROJECT_VERSION"
            exit 1
          fi

          echo "‚úÖ Version consistency check passed: $PYTHON_VERSION"

      - name: Build distribution packages
        run: |
          python -m pip install --upgrade build
          python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: distribution-packages
          path: dist/

  # Deploy to Staging (optional)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [release]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && contains(github.event.head_commit.message, '[deploy staging]')
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging environment
        run: |
          echo "üöÄ Deploying to staging environment..."
          # Add your staging deployment commands here
          echo "‚úÖ Staging deployment completed"
